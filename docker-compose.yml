version: '3.8'

services:
  #Fancy word for a container. If app has Spring Boot Backend and MySQL
  # DB, we would have 2 services here.
  app:
    #When we start this file SpringBoot starts much faster than MySQL.
    #So SpringBoot tries to connect to MySQL and crash because MySQL is not ready yet.
    #So we use depends_on to make SpringBoot wait for MySQL until MySQL is ready.
    depends_on: -mysqldb
    #Name we are giving to SpringBoot service. We can name it anything.
    #But it is good practice to name it something meaningful.
    build: .
    #Don't go to the internet to download an image for this service. Instead, look in this exact folder (.) for a 
    #Dockerfile, read the instructions in it, and build a brand-new custom image out of my source code right now."
    ports:
      #We are mapping the host port 8080 to the container port 8080.
      #By default, Docker containers run in total isolation. Even though your Spring Boot
      # app is running on port 8080 inside the container, your Mac cannot reach it unless 
      #we explicitly poke a hole for it
      - "8080:8080"
    environment:
      #Because localhost:3306 inside the container means the container itself, not your Mac, and there is no MySQL running inside the Spring Boot container!
      #Instead of changing your Java code, Docker allows us to inject Environment Variables that override 
      #application.properties when the container starts.
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysqldb:3306/userdb
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=V1gnesh@123

  mysqldb:
    #We dont use build because we are not building a custom image for MySQL. 
    #Instead, we are using the official MySQL image from Docker Hub.
    image: mysql:8.0
    ports: "3306:3306"
    environment:
      #MYSQL_DATABASE tells Docker: "When you start up for the very first time, 
      #create an empty database with this name." 
      #(Notice it matches the userdb name we told Spring Boot to look for!)
      -MYSQL_DATABASE = userdb -MYSQL_ROOT_PASSWORD=V1gnesh@123 #Matches the root user password we put in Spring Boot's application.properties
